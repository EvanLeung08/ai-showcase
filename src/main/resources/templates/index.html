<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Evan AI Showcase</title>
    <link th:rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link th:href="@{/css/bootstrap.min.css}" th:rel="stylesheet">
    <script th:src="@{/js/jquery-3.5.1.slim.min.js}"></script>
    <script th:src="@{/js/popper.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/js/marked.js}"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Evan AI Showcase</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link active" href="#home" data-toggle="tab">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#generate" data-toggle="tab">
                    <i class="fas fa-magic mr-2"></i>Word Master
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#preview" data-toggle="tab">
                    <i class="fas fa-eye mr-2"></i>Mnemonic Preview
                </a>
            </li>
            <!-- æ–°å¢å›¾åƒç”Ÿæˆå¯¼èˆªé¡¹ -->
            <li class="nav-item">
                <a class="nav-link" href="#imageGeneration" data-toggle="tab">
                    <i class="fas fa-image mr-2"></i>Awesome Image
                </a>
            </li>
            <!-- åœ¨å¯¼èˆªæ æ·»åŠ  -->
            <li class="nav-item">
                <a class="nav-link" href="#fortune" data-toggle="tab">
                    <i class="fas fa-star mr-2"></i>AI Fortune Telling
                </a>
            </li>
            <!-- åœ¨å¯¼èˆªæ æ·»åŠ  -->
            <li class="nav-item">
                <a class="nav-link" href="#translation" data-toggle="tab">
                    <i class="fas fa-language mr-2"></i>AI Translation
                </a>
            </li>
            <!-- åœ¨å¯¼èˆªæ æ·»åŠ  -->
            <li class="nav-item">
                <a class="nav-link" href="#book" data-toggle="tab">
                    <i class="fas fa-book-reader mr-2"></i>AI Reading
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="#copilot" data-toggle="tab">
                    <i class="fas fa-robot mr-2"></i>AI Copilot
                </a>
            </li>
            <!-- åœ¨å¯¼èˆªæ æ·»åŠ  -->
            <li class="nav-item">
                <a class="nav-link" href="#knowledge" data-toggle="tab">
                    <i class="fas fa-graduation-cap mr-2"></i>çŸ¥è¯†é—®ç­”
                </a>
            </li>
        </ul>
    </div>
</nav>
<div class="container mt-5">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="home">
            <div class="card shadow-lg">
                <div class="card-header text-center">
                    <h1 class="gradient-text">Welcome to Evan AI Showcase</h1>
                </div>
                <div class="card-body">
                    <p class="text-center">Use the tabs above to navigate through different functionalities.</p>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="generate">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary text-white">
                    <h1>English Word Memorization Aids</h1>
                </div>
                <div class="card-body">
                    <form id="pptForm" onsubmit="return validateGenerateForm()">
                        <div class="form-group">
                            <label for="prompt">Enter up to 5 English words, separated by commas:</label>
                            <textarea id="prompt" name="prompt" class="form-control" rows="5" required></textarea>
                            <div class="invalid-feedback">
                                Please enter up to 5 words, separated by commas.
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="generationType">Select Generation Type:</label>
                            <select id="generationType" name="generationType" class="form-control">
                                <option value="story">Word Story</option>
                                <option value="mnemonics" selected>Word Mnemonics</option>
                            </select>
                        </div>
                        <button type="submit" id="generateButton" class="btn btn-success btn-block"
                                onclick="setFormAction('/generate')">Generate PPT
                        </button>
                        <button type="submit" id="generatePdfButton" class="btn btn-danger btn-block"
                                onclick="setFormAction('/generatePdf')">Generate PDF
                        </button>
                    </form>
                    <div id="progressContainerGenerate" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div id="progressBarGenerate" class="progress-bar" role="progressbar" style="width: 0%;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div id="progressStatusGenerate" class="text-center mt-2"></div>
                    </div>
                    <div id="messageContainerGenerate" class="alert alert-danger mt-3" style="display: none;">
                        <p id="messageTextGenerate"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="preview">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary text-white">
                    <h1>English Word Memorization Aids Preview</h1>
                </div>
                <div class="card-body">
                    <form id="previewForm" onsubmit="return validatePreviewForm()">
                        <div class="form-group">
                            <label for="promptPreview">Enter up to 5 English words, separated by commas:</label>
                            <textarea id="promptPreview" name="prompt" class="form-control" rows="5"
                                      required></textarea>
                            <div class="invalid-feedback">
                                Please enter up to 5 words, separated by commas.
                            </div>
                        </div>
                        <!--   <div class="form-group">
                               <label for="generationTypePreview">Select Generation Type:</label>
                               <select id="generationTypePreview" name="generationType" class="form-control">
                                   <option value="story">Word Story</option>
                                   <option value="mnemonics" selected>Word Mnemonics</option>
                               </select>
                           </div>-->
                        <button type="button" id="previewButton" class="btn btn-primary btn-block"
                                onclick="previewPpt()">Preview
                        </button>
                    </form>
                    <div id="progressContainer" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div id="progressStatus" class="text-center mt-2"></div>
                    </div>
                    <div id="mnemonicContainer" class="mt-3" style="max-height: 500px; overflow-y: scroll"></div>
                    <div id="messageContainer" class="alert alert-danger mt-3" style="display: none;">
                        <p id="messageText"></p>
                    </div>
                </div>
            </div>
        </div>
        <!-- ï¿½ï¿½ï¿½ç°æœ‰æ ‡ç­¾é¡µç»“æ„ä¸­æ‰¾åˆ°åˆé€‚çš„ä½ç½®æ·»åŠ  -->
        <div class="tab-pane fade" id="imageGeneration">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary  text-white">
                    <h1>Awesome Image Generation</h1>
                </div>
                <div class="card-body">
                    <form id="imageForm" onsubmit="return generateImage()">
                        <div class="form-group">
                            <label for="imagePrompt">Please input the description of imageï¼š</label>
                            <textarea id="imagePrompt" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-block">Generate Image</button>
                    </form>
                    <div id="imageResult" class="mt-3 text-center" style="display: none;">
                        <img id="generatedImage" class="img-fluid rounded shadow" alt="Generated image"
                             style="max-height: 600px;">
                        <div class="mt-3">
                            <button onclick="downloadImage()" class="btn btn-primary">
                                <i class="fas fa-download mr-2"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- åœ¨æ ‡ç­¾é¡µåŒºåŸŸæ·»åŠ  -->
        <div class="tab-pane fade" id="fortune">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary  text-dark">
                    <h1>AIæ™ºèƒ½å‘½ç†åˆ†æ</h1>
                </div>
                <div class="card-body">
                    <form id="fortuneForm" onsubmit="return handleFortuneSubmit(event)">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="name">å§“åï¼š</label>
                                    <input type="text" id="name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="age">å¹´é¾„ï¼š</label>
                                    <input type="number" id="age" class="form-control" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="birthdate">å‡ºç”Ÿæ—¥æœŸï¼š</label>
                                    <input type="date" id="birthdate" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="time">æ—¶è¾°ï¼š</label>
                                    <input type="time" id="time" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="gender">æ€§åˆ«ï¼š</label>
                                    <select id="gender" class="form-control" required>
                                        <option value="male">ç”·</option>
                                        <option value="female">å¥³</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-dark btn-block">
                            <i class="fas fa-calculator mr-2"></i>ç”Ÿæˆå‘½ç†æŠ¥å‘Š
                        </button>
                    </form>
                    <div id="fortuneReport" class="fortune-report-container mt-4 p-3 bg-light rounded"></div>
                </div>
            </div>
        </div>

        <!-- translation æ¨¡å— -->
        <div class="tab-pane fade" id="translation">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary  text-dark">
                    <h1>AI Translation</h1>
                </div>
                <div class="card-body">
                    <form id="translationForm">

                        <div class="form-group">
                            <label>ç¿»è¯‘æ–¹å‘</label>
                            <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                                <label class="btn btn-outline-primary active">
                                    <input type="radio" name="direction" value="zh2en" checked> ä¸­è¯‘è‹±
                                </label>
                                <label class="btn btn-outline-primary">
                                    <input type="radio" name="direction" value="en2zh"> è‹±è¯‘ä¸­
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="text">è¾“å…¥æ–‡æœ¬</label>
                            <textarea class="form-control" id="text" rows="5"
                                      placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦ç¿»è¯‘çš„å†…å®¹ï¼ˆæœ€å¤š500å­—ï¼‰"></textarea>
                        </div>
                        <button type="button" class="btn btn-primary" id="translateButton" onclick="translateText()">
                            <span id="translateText">Translate</span>
                            <span id="translateSpinner" class="spinner-border spinner-border-sm" role="status"
                                  style="display: none;"></span>
                        </button>
                    </form>
                    <div id="translationResult" class="mt-3"></div>
                </div>
            </div>
        </div>


        <!-- æ·»åŠ é˜…è¯»æ¨¡å— -->
        <div class="tab-pane fade" id="book">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary  text-dark">
                    <h1>AIæ™ºèƒ½é˜…è¯»åŠ©æ‰‹</h1>
                </div>
                <div class="card-body">
                    <form id="bookForm" enctype="multipart/form-data">
                        <!-- ä¿®æ”¹åçš„æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† -->
                        <div class="form-group">
                            <label for="bookTitle">ä¹¦ç±åç§°</label>
                            <input type="text" class="form-control" id="bookTitle"
                                   required placeholder="è¯·è¾“å…¥ä¹¦ç±åç§°">
                        </div>


                        <!-- åœ¨æ–‡ä»¶ä¸Šä¼ inputå…ƒç´ ä¸‹æ–¹æ·»åŠ æ–‡ä»¶åˆ—è¡¨å®¹å™¨ -->
                        <div class="form-group">
                            <label for="bookFile">ä¸Šä¼ ä¹¦ç±ï¼ˆä»…PDFï¼‰</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="bookFile"
                                       name="bookFile" accept=".pdf"
                                       onchange="updateFileList(this)">
                                <label class="custom-file-label" for="bookFile">é€‰æ‹©PDFæ–‡ä»¶</label>
                            </div>
                            <!-- æ–°å¢æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="fileList" class="mt-2 small text-muted" style="min-height: 40px;"></div>
                        </div>
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-brain mr-2"></i>ç”Ÿæˆè¯»ä¹¦ç¬”è®°
                        </button>
                    </form>
                    <!-- ä¿®æ”¹åçš„è¿›åº¦æ˜¾ç¤º -->
                    <div id="bookProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <p class="text-center mt-2">
                            å¤„ç†è¿›åº¦ï¼š<span id="processedPercentage">0%</span>
                            ï¼ˆ<span id="processedPages">0</span>/<span id="totalPages">0</span>é¡µï¼‰
                        </p>
                    </div>
                    <div id="bookResult" class="mt-3"></div>
                </div>
            </div>
        </div>


        <div class="tab-pane fade" id="copilot">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary  text-dark">
                    <h1>GitHub Copilot Chat</h1>
                </div>
                <div class="card-body">
                    <!-- æˆæƒçŠ¶æ€æ˜¾ç¤º -->
                    <div id="authStatus" class="alert alert-info" style="display:none;">
                        <div id="userCodeDisplay"></div>
                        <a id="verificationLink" target="_blank" class="btn btn-sm btn-success mt-2">
                            <i class="fas fa-external-link-alt"></i> å‰å¾€æˆæƒ
                        </a>
                    </div>

                    <!-- èŠå¤©ç•Œé¢ -->
                    <div id="chatInterface" style="display:none;">
                        <div class="chat-messages mb-3"
                             style="height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 15px;">
                        </div>
                        <div class="input-group">
    <textarea id="chatInput" class="form-control"
              placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="3"></textarea>
                            <div class="input-group-append">
                                <!-- æ–°å¢æŒ‰é’® -->
                                <button class="btn btn-secondary mr-2" onclick="startNewChat()"
                                        title="æ¸…é™¤å¯¹è¯å†å²">
                                    <i class="fas fa-comment-slash"></i> æ–°å¯¹è¯
                                </button>
                                <button class="btn btn-primary" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i> å‘é€
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœªæˆæƒæ—¶çš„æ“ä½œæŒ‰é’® -->
                <button id="startAuth" class="btn btn-dark btn-block" onclick="startCopilotAuth()">
                    <i class="fab fa-github mr-2"></i>æˆæƒGitHubè´¦æˆ·
                </button>
            </div>
        </div>

        <!-- åœ¨æ ‡ç­¾é¡µåŒºåŸŸæ·»åŠ  -->
        <div class="tab-pane fade" id="knowledge">
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary  text-dark">
                    <h1>çŸ¥è¯†é—®ç­”ç³»ç»Ÿ</h1>
                </div>
                <div class="card-body">
                    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="mb-4">
                        <form id="knowledgeForm" enctype="multipart/form-data">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="knowledgeFile"
                                       accept=".txt,.pdf,.md" multiple>
                                <label class="custom-file-label" for="knowledgeFile">é€‰æ‹©çŸ¥è¯†æ–‡ä»¶</label>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">
                                <i class="fas fa-upload mr-2"></i>ä¸Šä¼ å¹¶æ„å»ºçŸ¥è¯†åº“
                            </button>
                        </form>
                        <div id="uploadProgress" class="mt-3" style="display:none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped" role="progressbar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- é—®ç­”äº¤äº’åŒºåŸŸ -->
                    <div id="qaInterface">
                        <div class="chat-messages mb-3"
                             style="height: 300px; overflow-y: auto; border: 1px solid #ddd;"></div>
                        <div class="input-group">
                    <textarea id="qaInput" class="form-control"
                              placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="2"></textarea>
                            <div class="input-group-append">
                                <button class="btn btn-success" onclick="askQuestion()">
                                    <i class="fas fa-paper-plane"></i> æé—®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<footer class="footer">
    <div class="container">
        <p class="text-center mb-0">
            <span class="text-muted">&copy; 2025 Evan Leung</span>
            <span class="mx-3">|</span>
            <span class="text-muted">Powered by Evan AI Technology</span>
        </p>
    </div>
</footer>


<!--Navigation-->
<script>
    document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(event) {
        event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('show', 'active'));
        const target = document.querySelector(this.getAttribute('href'));
        target.classList.add('show', 'active');
    });
});
</script>

<script>
    let isRequestInProgress = false;

    function validateForm(textareaId) {
        var prompt = document.getElementById(textareaId);
        var words = prompt.value.split(',').map(word => word.trim()).filter(word => word.length > 0);
        if (words.length === 0 || words.length > 5) {
            prompt.classList.add("is-invalid");
            return false;
        }
        prompt.classList.remove("is-invalid");
        return true;
    }

    function validateGenerateForm() {
        return validateForm('prompt');
    }

    function validatePreviewForm() {
        return validateForm('promptPreview');
    }

    function showMessage(message, containerId, textId) {
        var messageContainer = document.getElementById(containerId);
        var messageText = document.getElementById(textId);
        messageText.innerText = message;
        messageContainer.style.display = "block";
        setTimeout(() => {
            messageContainer.style.display = "none";
        }, 3000);
    }

    function setFormAction(action) {
        document.getElementById('pptForm').action = action;
    }

    function handleGenerate(event, action) {
        event.preventDefault();
        if (!validateGenerateForm()) {
            showMessage("Please enter 1-5 words separated by commas", "messageContainerGenerate", "messageTextGenerate");
            return;
        }

        if (isRequestInProgress) {
            showMessage("Please wait for the current request to complete.", "messageContainerGenerate", "messageTextGenerate");
            return;
        }

        var prompt = document.getElementById("prompt").value;
        var generationType = document.getElementById("generationType").value;
        var progressBar = document.getElementById("progressBarGenerate");
        var progressStatus = document.getElementById("progressStatusGenerate");
        var progressContainer = document.getElementById("progressContainerGenerate");
        var generateButton = document.getElementById("generateButton");
        var generatePdfButton = document.getElementById("generatePdfButton");

        isRequestInProgress = true;
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressBar.setAttribute("aria-valuenow", 0);
        progressBar.classList.remove("bg-success", "bg-danger");
        progressStatus.innerText = "Generating... This may take 1-2 minutes.";
        generateButton.disabled = true;
        generatePdfButton.disabled = true;

        fetch(action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({prompt: prompt, generationType: generationType})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        })
        .then(blob => {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = action === '/generate' ? 'handbook.pptx' : 'handbook.pdf';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            progressStatus.innerText = "Generation completed!";
            progressBar.style.width = "100%";
            progressBar.setAttribute("aria-valuenow", 100);
            progressBar.classList.add("bg-success");
        })
        .catch(error => {
            console.error('Error:', error);
            progressStatus.innerText = "Error occurred!";
            showMessage("An error occurred while generating the file. Please try again.", "messageContainerGenerate", "messageTextGenerate");
            progressBar.style.width = "100%";
            progressBar.classList.add("bg-danger");
        })
        .finally(() => {
            isRequestInProgress = false;
            generateButton.disabled = false;
            generatePdfButton.disabled = false;
        });
    }
// åœ¨åŸæœ‰previewPptå‡½æ•°ä¸Šæ–¹æ·»åŠ æ–°çš„å¤„ç†å‡½æ•°
function renderMnemonicWithImages(data) {
    const container = document.getElementById("mnemonicContainer");
    container.innerHTML = data.map(item => `
        <div class="card mb-3 animated fadeIn">
            <div class="card-header bg-info text-white">
                <h5>${item.word}</h5>
            </div>
            <div class="card-body markdown-body">  <!-- æ·»åŠ markdown-bodyç±» -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>è®°å¿†æŠ€å·§ï¼š</h6>
                            <div class="bg-light p-3 rounded">${item.mnemonic}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
<div class="image-gallery">
    ${item.images.slice(0,1).map(image => `
        <img src="data:image/png;base64,${image}"
             class="img-fluid rounded shadow mb-3"
             style="max-height: 300px;">
    `).join('')}
</div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}
    function previewPpt() {
        if (!validatePreviewForm()) {
            showMessage("Please enter 1-5 words separated by commas", "messageContainer", "messageText");
            return;
        }

        var prompt = document.getElementById("promptPreview").value;
       // var generationType = document.getElementById("generationTypePreview").value;
        var progressBar = document.getElementById("progressBar");
        var progressStatus = document.getElementById("progressStatus");
        var progressContainer = document.getElementById("progressContainer");
        var pptPreview = document.getElementById("pptPreview");

        isRequestInProgress = true;
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressBar.setAttribute("aria-valuenow", 0);
        progressStatus.innerText = "Generating preview... This may take 1-2 minutes.";

          fetch("/getMnemonicWithImages", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ prompt })
    }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
        document.getElementById("mnemonicContainer").innerHTML = "";
        renderMnemonicWithImages(data);
            progressStatus.innerText = "Preview completed!";
            progressBar.style.width = "100%";
            progressBar.setAttribute("aria-valuenow", 100);
            progressBar.classList.add("bg-success");
        })
        .catch(error => {
            console.error('Error:', error);
            progressStatus.innerText = "Error occurred!";
            showMessage("An error occurred while generating the preview. Please try again.", "messageContainer", "messageText");
            progressBar.style.width = "100%";
            progressBar.classList.add("bg-danger");
        })
        .finally(() => {
            isRequestInProgress = false;
        });
    }

    document.getElementById('generateButton').addEventListener('click', function(event) {
        handleGenerate(event, '/generate');
    });

    document.getElementById('generatePdfButton').addEventListener('click', function(event) {
        handleGenerate(event, '/generatePdf');
    });


    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.createElement('canvas');
        canvas.style.position = 'fixed';
        canvas.style.top = 0;
        canvas.style.left = 0;
        canvas.style.zIndex = -1;
        document.body.appendChild(canvas);
    });
</script>
<!-- åœ¨é¡µé¢åº•éƒ¨çš„scriptéƒ¨åˆ†æ·»åŠ  -->
<script th:inline="javascript">
    function generateImage() {
        const prompt = document.getElementById('imagePrompt').value;
        const resultDiv = document.getElementById('imageResult');

        fetch('/generateImage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({prompt: prompt})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('generatedImage').src = `data:image/png;base64,${data.image}`;
                resultDiv.style.display = 'block';
            } else {
                alert(data.message);
            }
        });
        return false;
    }

    function downloadImage() {
        const image = document.getElementById('generatedImage');
        const link = document.createElement('a');
        link.download = 'generated-image.png';
        link.href = image.src;
        link.click();
    }
</script>
<!--AIç®—å‘½-->
<script th:inline="javascript">
    async function handleFortuneSubmit(event) {
     event.preventDefault();

     const reportDiv = document.getElementById('fortuneReport');
     reportDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

     try {
         const response = await fetch('/generateFortune', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json'
             },
             body: JSON.stringify({
                 name: document.getElementById('name').value,
                 age: document.getElementById('age').value,
                 birthdate: document.getElementById('birthdate').value,
                 time: document.getElementById('time').value,
                 gender: document.getElementById('gender').value
             })
         });

         const data = await response.json();
         if (data.report) {
             reportDiv.innerHTML = marked.parse(data.report);
         } else {
             reportDiv.innerHTML = '<div class="alert alert-danger">ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>';
         }
     } catch (error) {
         reportDiv.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
     }
 }
</script>

<script>
    function translateText() {
      const direction = document.querySelector('input[name="direction"]:checked').value;
      const [sourceLang, targetLang] = direction === 'zh2en' ? ['ä¸­æ–‡', 'è‹±æ–‡'] : ['è‹±æ–‡', 'ä¸­æ–‡'];
      const text = document.getElementById('text').value;

      const resultDiv = document.getElementById('translationResult');
      const translateBtn = document.getElementById('translateButton');
      const spinner = document.getElementById('translateSpinner');

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      translateBtn.disabled = true;
      spinner.style.display = 'inline-block';
      resultDiv.innerHTML = `<div class="alert alert-info text-center">
          <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ç¿»è¯‘ä¸­ï¼Œè¯·ç¨å€™...
      </div>`;

      fetch('/translate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
              text,
              sourceLang,
              targetLang
          })
      })
      .finally(() => {
          // æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ¢å¤æŒ‰é’®çŠ¶æ€
          translateBtn.disabled = false;
          spinner.style.display = 'none';
      })
          .then(response => {
              if (!response.ok) throw new Error('æœåŠ¡å™¨é”™è¯¯ï¼š' + response.status);
              return response.json();
          })
          .then(data => {
              const resultDiv = document.getElementById('translationResult');
              resultDiv.innerHTML = `<div class="alert alert-success">
                  <p><strong>åŸæ–‡ï¼ˆ${sourceLang}ï¼‰:</strong><br>${text}</p>
                  <hr>
                  <p><strong>è¯‘æ–‡ï¼ˆ${targetLang}ï¼‰:</strong><br>${data.translatedText}</p>
              </div>`;
          })
          .catch(error => {
              const resultDiv = document.getElementById('translationResult');
              resultDiv.innerHTML = `<div class="alert alert-danger">
                  ç¿»è¯‘å¤±è´¥ï¼š${error.message}
              </div>`;
          });
      }

</script>
<!--AIé˜…è¯»-->
<script>
    // åœ¨ç°æœ‰scriptæ ‡ç­¾å†…æ·»åŠ æ–‡ä»¶åˆ—è¡¨æ›´æ–°å‡½æ•°
    function updateFileList(input) {
        const fileList = document.getElementById('fileList');
        const files = Array.from(input.files);

        // æ¸…ç©ºåŸæœ‰å†…å®¹
        fileList.innerHTML = '';

        // æ˜¾ç¤ºæ¯ä¸ªæ–‡ä»¶ä¿¡æ¯
        files.forEach(file => {
            const fileSize = file.size > 1024 * 1024
                ? `${(file.size/1024/1024).toFixed(2)}MB`
                : `${Math.round(file.size/1024)}KB`;

            fileList.innerHTML += `
                <div class="alert alert-secondary p-2 mb-2">
                    <i class="fas fa-file-pdf mr-2 text-danger"></i>
                    ${file.name} (${fileSize})
                </div>
            `;
        });

        // æ˜¾ç¤ºæ€»æ•°
        if (files.length > 0) {
            fileList.innerHTML += `
                <div class="text-muted mt-2">
                    å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶
                </div>
            `;
        }
    }
        // åœ¨ç°æœ‰scriptæ ‡ç­¾å†…æ·»åŠ 
    function updateFileList(input) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = Array.from(input.files)
            .map(file => `<div>ğŸ“„ ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)</div>`)
            .join('');
    }

async function handleBookUpload(event) {
    event.preventDefault();
    const files = document.getElementById('bookFile').files;
    const bookTitle = document.getElementById('bookTitle').value;

    // åˆå§‹åŒ–è¿›åº¦æ¡
    const progressBar = document.querySelector('#bookProgress .progress-bar');
    const progressStatus = document.getElementById('processedPercentage');
    const processedPagesSpan = document.getElementById('processedPages');
    const totalPagesSpan = document.getElementById('totalPages');
    const bookProgress = document.getElementById('bookProgress');
    const resultDiv = document.getElementById('bookResult');

    // é‡ç½®çŠ¶æ€
    bookProgress.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.classList.remove('bg-danger', 'bg-success');
    progressStatus.textContent = '0%';
    processedPagesSpan.textContent = '0';
    totalPagesSpan.textContent = '0';
    resultDiv.innerHTML = '';

    try {
        const response = await fetch('/generateBookNote', {
            method: 'POST',
            headers: {
                'X-Book-Title': encodeURIComponent(bookTitle)
            },
            body: prepareFormData(files)
        });

        const data = await response.json();
        progressBar.style.width = '100%';
        progressBar.classList.add('bg-success');
        progressStatus.textContent = '100%';
        processedPagesSpan.textContent = '1';
        totalPagesSpan.textContent = '1';

        // Display HTML properly
        resultDiv.innerHTML = data.report;
    } catch (error) {
        console.error('Error:', error);
        progressBar.style.width = '100%';
        progressBar.classList.add('bg-danger');
        progressStatus.textContent = 'é”™è¯¯';
        resultDiv.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå¤±è´¥ï¼š${error.message}</div>`;
    }
}

function concatUint8Arrays(arrays) {
    let totalLength = arrays.reduce((acc, value) => acc + value.length, 0);
    let result = new Uint8Array(totalLength);
    let offset = 0;
    for (let arr of arrays) {
        result.set(arr, offset);
        offset += arr.length;
    }
    return result;
}

    // ä¿®å¤è¡¨å•ç»‘å®šï¼ˆåœ¨DOMåŠ è½½åæ·»åŠ ï¼‰
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('bookForm').addEventListener('submit', handleBookUpload);
    });

    function prepareFormData(files) {
        const formData = new FormData();
        formData.append("bookTitle", document.getElementById('bookTitle').value);
        Array.from(files).forEach(file => formData.append("bookFile", file));
        return formData;
    }
      // ç»‘å®šè¡¨å•æäº¤ï¿½ï¿½ï¿½ä»¶
      document.getElementById('bookForm').addEventListener('submit', handleBookUpload);

</script>

<script th:inline="javascript">
    // åœ¨ç°æœ‰è„šæœ¬åæ·»åŠ ä»¥ä¸‹ä»£ç 
let isAuthorizing = false;

async function startCopilotAuth() {
    if (isAuthorizing) return;
    isAuthorizing = true;

    const authBtn = document.getElementById('startAuth');
    authBtn.disabled = true;
    authBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è·å–æˆæƒç ...';

    try {
        const response = await fetch('/copilot/auth');
        const data = await response.json();

        document.getElementById('userCodeDisplay').innerHTML = `
            <h5>ç”¨æˆ·éªŒè¯ç ï¼š</h5>
            <div class="alert alert-secondary py-1 px-3 d-inline-block">
                <h2 class="mb-0">${data.userCode}</h2>
            </div>
            <p class="mt-2 mb-0">è¯·è®¿é—®ä»¥ä¸‹é“¾æ¥å®Œæˆæˆæƒï¼ŒæˆæƒæˆåŠŸå20ç§’è‡ªåŠ¨è¿›å…¥èŠå¤©æ¨¡å¼ï¼š</p>
        `;

        const link = document.getElementById('verificationLink');
        link.href = data.verificationUri;
        link.innerHTML = `<i class="fas fa-external-link-alt"></i> ${data.verificationUri}`;

        document.getElementById('authStatus').style.display = 'block';
        authBtn.style.display = 'none';

       // æ–°å¢ç‚¹å‡»äº‹ä»¶ç›‘å¬
link.addEventListener('click', function(e) {
    pollAuthStatus();  // è§¦å‘è½®è¯¢
    return true;
});

    } catch (error) {
        showMessage("è·å–æˆæƒç å¤±è´¥ï¼š" + error.message, "authStatus", "userCodeDisplay");
    } finally {
        isAuthorizing = false;
        authBtn.disabled = false;
        authBtn.innerHTML = '<i class="fab fa-github mr-2"></i>æˆæƒGitHubè´¦æˆ·';
    }
}

async function pollAuthStatus() {
const url = `/copilot/callback`;
    const checkStatus = async () => {
        try {
            const response = await fetch(url);
            if (response.status === 200) {
                document.getElementById('authStatus').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'block';
                return true;
            }
        } catch (e) {
            console.error('æˆæƒçŠ¶æ€æ£€æŸ¥å¤±è´¥:', e);
        }
        return false;
    };

    const interval = setInterval(async () => {
        if (await checkStatus()) {
            clearInterval(interval);
        }
    }, 20000);
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    const chatWindow = document.querySelector('.chat-messages');

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    chatWindow.innerHTML += `
        <div class="alert alert-primary mb-2 p-2">
            <strong>You:</strong> ${message}
        </div>
    `;

    // æ·»åŠ åŠ è½½çŠ¶æ€
    chatWindow.innerHTML += `
        <div class="alert alert-secondary mb-2 p-2">
            <i class="fas fa-spinner fa-spin"></i> æ€è€ƒä¸­...
        </div>
    `;

    try {
        const response = await fetch('/copilot/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        // ç§»é™¤åŠ è½½çŠ¶æ€
        chatWindow.lastElementChild.remove();

        // æ·»åŠ AIå“åº”ï¼ˆæ”¯æŒMarkdownæ¸²æŸ“ï¼‰
        chatWindow.innerHTML += `
            <div class="alert alert-success mb-2 p-2">
                <strong>AI:</strong> ${marked.parse(data.response)}
            </div>
        `;

    } catch (error) {
        chatWindow.lastElementChild.remove();
        chatWindow.innerHTML += `
            <div class="alert alert-danger mb-2 p-2">
                <strong>Error:</strong> ${error.message}
            </div>
        `;
    }

    input.value = '';
    chatWindow.scrollTop = chatWindow.scrollHeight;
}
    async function startNewChat() {
    try {
        const response = await fetch('/copilot/new_chat', {
            method: 'GET'
        });
        if (response.ok) {
            document.querySelector('.chat-messages').innerHTML = '';
            showMessage('å·²å¼€å¯æ–°å¯¹è¯ï¼Œä¸Šä¸‹æ–‡å†å²å·²æ¸…é™¤', 'chatInterface');
        }
    } catch (error) {
        console.error('æ–°å¯¹è¯åˆ›å»ºå¤±è´¥:', error);
        showMessage('æ–°å¯¹è¯åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'chatInterface');
    }
}
</script>

<script th:inline="javascript">
    // åœ¨ç°æœ‰scriptæ ‡ç­¾ä¸­æ·»åŠ 
let knowledgeChatHistory = [];

async function askQuestion() {
    const input = document.getElementById('qaInput');
    const message = input.value.trim();
    if (!message) return;

    const chatBox = document.querySelector('#qaInterface .chat-messages');

    // æ·»åŠ ç”¨æˆ·é—®é¢˜
    chatBox.innerHTML += `
        <div class="alert alert-primary mb-2">${message}</div>
    `;

    try {
        const response = await fetch('/knowledge/ask', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({question: message})
        });

        const data = await response.json();
        chatBox.innerHTML += `
            <div class="alert alert-success mb-2">${data.answer}</div>
        `;
    } catch (error) {
        chatBox.innerHTML += `
            <div class="alert alert-danger mb-2">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>
        `;
    }

    input.value = '';
    chatBox.scrollTop = chatBox.scrollHeight;
}
    // åœ¨ç°æœ‰scriptæ ‡ç­¾ä¸­æ·»åŠ ä»¥ä¸‹äº‹ä»¶ç›‘å¬
document.getElementById('knowledgeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const files = document.getElementById('knowledgeFile').files;
    const formData = new FormData();

       // ä¿®æ”¹FormDataçš„é”®å
 for (const file of files) { // æ·»åŠ å¾ªç¯å¤„ç†å¤šä¸ªæ–‡ä»¶
        const blob = new Blob([file], {
            type: getMimeType(file.name)
        });
        formData.append('files', blob, file.name);
    }

    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
    const progressBar = document.querySelector('#uploadProgress .progress-bar');
    const uploadProgress = document.getElementById('uploadProgress');
    uploadProgress.style.display = 'block';
    progressBar.style.width = '0%';



function getMimeType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    return {
        'txt': 'text/plain',
        'md': 'text/markdown',
        'pdf': 'application/pdf'
    }[ext] || 'application/octet-stream';
}
    // å‘é€AJAXè¯·æ±‚
    fetch('/knowledge/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');
        return response.json();
    })
    .then(data => {
        progressBar.style.width = '100%';
        setTimeout(() => uploadProgress.style.display = 'none', 2000);
        alert('çŸ¥è¯†åº“æ„å»ºæˆåŠŸï¼');
    })
    .catch(error => {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        progressBar.style.width = '100%';
        progressBar.classList.add('bg-danger');
        alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
    });
});

// æ·»åŠ æ–‡ä»¶é€‰æ‹©ç›‘å¬æ›´æ–°æ ‡ç­¾
document.getElementById('knowledgeFile').addEventListener('change', function(e) {
    const label = this.nextElementSibling;
    label.textContent = this.files.length > 1 ?
        `${this.files.length}ä¸ªæ–‡ä»¶å·²é€‰æ‹©` :
        this.files[0].name;
});
</script>
</body>
</html>
